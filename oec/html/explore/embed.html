{% extends "templates/base.html" %}

{% block head %}
<link type="text/css" rel="stylesheet" media="all" href="/static/css/libs/d3plus.css" />
<link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.embed.css" />
{% endblock %}

{% block content %}

<div id="loading"><h1>{{ _('Loading') }}...</h1></div>
<div id="app">
  <div id="text"></div>
  <div id="viz"></div>
  <div id="ui">
    <div id="more_years"><button>{{ _('Click to view more years') }} &raquo;</button></div>
    <div id="depth">
      <input type="radio" name="nesting" value="0">Category
      <input type="radio" name="nesting" value="1" checked="checked">Full
    </div>
    <div id="color">
      <select>
        <option value="color">Category</option>
        <option value="val_growth_pct">Annual Growth Rate (1 year)</option>
        <option value="val_growth_pct_5">Annual Growth Rate (5 year)</option>
        <option value="val_growth_val">Growth Value (1 year)</option>
        <option value="val_growth_val_5">Growth Value (5 year)</option>
      </select>
    </div>
  </div>
</div>
<div id="controls">
  
  <div id="show_hide"><i class="fa fa-angle-double-right"></i></div>
  
  {% for ui in current_build.get_ui() %}
  <div class="dropdown_container" id="{{ ui.id }}">
    <h3>{{ ui.name }}</h3>
    <select>
      {% for option in ui.data %}
      <option value="{% if option is string or option is number %}{{option|replace(" ", "_")}}{% else %}{{option.display_id}}{% endif %}"
      {% if ui.current|lower|replace(" ", "_") == option|lower|replace(" ", "_") %}selected="selected"{% endif %}>
        {% if option is string or option is number %}{{ option }}
        {% else %}{{ option.name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
  </div>
  {% endfor %}
  
  <button id="build">{{ _('Build Visualization') }}</button>
  
  <div class="control_container" id="download">
    <h3>{{ _('Download') }}</h3>
    <a class="pdf" href="#"><img src="/static/img/icons/download.png"> PDF</a>
    <a class="svg" href="#"><img src="/static/img/icons/download.png"> SVG</a>
    <a class="png" href="#"><img src="/static/img/icons/download.png"> PNG</a>
    <a class="csv" href="#"><img src="/static/img/icons/download.png"> CSV</a>
  </div>
  
  <div class="control_container" id="view_as_text">
    <a class="text" href="#"><img src="/static/img/icons/text.png"> <span>{{ _('View as text') }}</span></a>
  </div>
  
  <div class="control_container">
    <h3>{{ _('Embed') }}</h3>
    <input type="text" class="embed_code" onfocus="this.select()" onMouseUp="return false" value="&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://atlas.media.mit.edu/explore/embed/{{ current_build.url() }}&quot; frameborder=&quot;0&quot; &gt;&lt;/iframe&gt;">
  </div>
  
  <div class="control_container" id="share">
    <h3>{{ _('Share') }}</h3>
    <a href="http://www.facebook.com/sharer.php?s=100&p[title]=Observatory of Economic Complexity&p[summary]={{ current_build.get_name() }}({{ current_build.get_year() }})&p[url]=http://atlas.media.mit.edu/explore/{{ current_build.url() }}&p[images][0]=http://atlas.media.mit.edu/static/img/icons/nav/logo_large.png" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" id="Facebook" title="Facebook">
      <i class="fa fa-facebook"></i>
    </a>
    <a href="https://twitter.com/share?url=http://atlas.media.mit.edu/explore/{{ current_build.url() }}&text={{ current_build.get_name() }}({{ current_build.get_year() }})&hashtags=oec" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')" id="Twitter" title="Tweet">
      <i class="fa fa-twitter"></i>
    </a>
    <a href="https://plus.google.com/share?url=http://atlas.media.mit.edu/explore/{{ current_build.url() }}" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Google+', 'width=640,height=300')" id="Google" title="Google+">
      <i class="fa fa-google-plus"></i>
    </a>
    <a href="#" id="shorten">
      <i class="fa fa-link"></i>
    </a>
  </div>

  <div class="control_container" id="short">
    <h3>{{ _('Short URL') }}</h3>
    <input type="text" class="short_url" onfocus="this.select()" onMouseUp="return false" value="http://atlas.media.mit.edu/asdlkj43">
  </div>
  
  <!-- Hidden <FORM> to submit the SVG data to the server, which will convert it 
         to SVG/PDF/PNG downloadable file. -->
  <form id="download" action="/explore/download/" method="post">
    <input type="hidden" name="url" value="" />
    <input type="hidden" name="title" value="" />
    <input type="hidden" name="format" value="svg" />
    <input type="hidden" name="content" value="" />
  </form>
  
</div>

{% endblock %}

{% block js %}

<script src="/static/js/libs/modernizr.custom.js"></script>
<script src="/static/js/libs/d3plus.js"></script>
<script src="/static/js/libs/queue.js"></script>
<script src="/static/js/libs/topojson.js"></script>
<script src="/static/js/d3.brushmore_years.js"></script>
<script src="/static/js/d3.tabulate.js"></script>

<script>

/* init vars */
var viz = d3plus.viz()
            .container("#viz")
            .style({"background":"transparent"})
            .text_format(function(text, key){
              // console.log(text, key)
              if(key == "display_id"){
                return "ID"
              }
              return text
            }),
    attr_id = "{{ current_build.attr_type() }}_id",
    app_type = "{{ current_build.app.type }}",
    attrs = {},
    viz_height = window.innerHeight - d3.select("#ui").node().offsetHeight,
    viz_width = window.innerWidth - parseInt(d3.select("#controls").style("width")),
    q = queue()
          .defer(d3.json, "{{ current_build.data_url() }}")
          .defer(d3.json, "{{ current_build.attr_url() }}");

if(attr_id == "dest_id" || attr_id == "dest_id"){
  viz = viz.tooltip({"Country":["name", "display_id"], "Values":["export_val"]} )
}
if(attr_id == "hs_id" || attr_id == "sitc_id" ){
  viz = viz
          .style({"icon":"knockout"})
          .tooltip({"Product":["name", "display_id"], "Values":["export_val"]} )
}

function resize_viz(obj){
  
  if(viz.data().value.length){
    var new_width = window.innerWidth - parseInt(d3.select("#controls").style("width"));
    var new_height = window.innerHeight - d3.select("#ui").node().offsetHeight;
    if (obj){
      new_width = obj.width || new_width;
      new_height = obj.height || new_height;
    }
    viz.width(new_width).height(new_height).draw()
    d3.select("#app #viz")
      .style("width", new_width+"px")
      .style("height", new_height+"px")
    d3.select("#app #text")
      .style("width", new_width+"px")
      .style("height", new_height+"px")
  }
  
}
/* general function needed by all apps for making proper nesting and updating
    raw data with changes */
function format_data(error, raw_data, raw_attrs, raw_other){
  
  // set key 'nest' to their id
  raw_attrs.data.forEach(function(d){
    attrs[d.id] = d
    if(attr_id == "dest_id" || attr_id == "dest_id"){
      attrs[d.id]["icon"] = "/static/img/icons/country/country_"+d.id+".png"
    }
    else if(attr_id == "hs_id"){
      attrs[d.id]["icon"] = "/static/img/icons/hs/hs_"+d.id.substr(0, 2)+".png"
    }
    else if(attr_id == "sitc_id"){
      attrs[d.id]["icon"] = "/static/img/icons/sitc/sitc_"+d.id.substr(0, 2)+".png"
    }
    if(attrs[d.id]["display_id"]){
      attrs[d.id]["display_id"] = attrs[d.id]["display_id"].toUpperCase()
    }
    // console.log(attrs[d.id])
  })

  // go through raw data and set each items nest and id vars properly
  raw_data.data.forEach(function(d){
    d.nest = d[attr_id].substr(0, 2)
    d.id = d[attr_id]
  })
  
}

/* to be executed after app has been drawn for first time */
function finish(data, attrs){
  d3.select("#controls")
    .style("display", "inline-block")
    
  d3.select("#loading")
    .style("display", "none")
    
  d3.select("#viz")
    .style("display", "block")
    .call(viz)
  
  d3.select("#ui").style("display", "block")
  
  update_text_table(data, attrs)
}

/* the ~~BIG KAHUNA~~ 
    for each different type of app we need to initialize our viz slightly
    different so instead of a bunch of if/elses we just have one large switch
    statment. Any gerealized code is put in either the format_data() func or
    the finish() func. */
switch (app_type){
  
  case "tree_map":
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1]
      
      viz
        .data(raw_data.data)
        .type("tree_map")
        .attrs(attrs)
        .size("{{ current_build.trade_flow }}_val")
        .id(["nest", "id"])
        .time({"key": "year", "solo": "{{ current_build.year }}" })
        // .time({"key": "year"})
        .depth(1)
        .shape("square")
        .style({"labels": {"align": "start"}})
        .color("color")
        .text({"nest":"name","id":"name"})
        // .title("Tree Map...")
        .title({"total": {"prefix":"Total: "}})
        .height(viz_height)
        .width(viz_width)
        .icon("icon")
      
      finish(raw_data.data, attrs)
    }
    break;
  
  case "stacked":
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1]
      
      viz
        .data(raw_data.data)
        .type("stacked")
        .attrs(attrs)
        .id(["nest", "id"])
        .time({"key": "year"})
        .depth(1)
        .shape("area")
        .color("color")
        .x("year")
        .y("{{ current_build.trade_flow }}_val")
        .order("nest")
        .axes({"static":false})
        .text({"nest":"name","id":"name"})
        .height(window.innerHeight - d3.select("#ui").node().offsetHeight)
        .width(viz_width)
        
      finish(raw_data.data, attrs)
    }
    break;
  
  case "network":
    q = q.defer(d3.json, "/static/json/network_{{ current_build.classification }}.json")
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1];
      raw_network = arguments[3];
            
      viz
        .data(raw_data.data)
        .attrs(attrs)
        .type("network")
        .id("id")
        .color("color")
        .time("year")
        .nodes(raw_network.nodes)
        .links(raw_network.edges)
        .active({
          "key": function(d){
            return d.export_rca >= 1;
          },
          "spotlight":true
        })
        .height(window.innerHeight - d3.select("#ui").node().offsetHeight)
        .width(viz_width)
      
      finish(raw_data.data, attrs)
    }
    break;
    
  case "geo_map":
    q = q.defer(d3.json, "/static/json/country_coords.json")
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1];
      raw_attrs = arguments[2];
      raw_coords = arguments[3];
            
      raw_coords["objects"]["TM_WORLD_BORDERS-0.3"]["geometries"].forEach(function(d){
        country = raw_attrs.data.filter(function(dd){
          return dd.id.substr(2) == d.id.toLowerCase()
        })
        if (country.length) {
          d.id = country[0].id
        }
      })
      
      viz
        .data(raw_data.data)
        .attrs(attrs)
        .type("geo_map")
        .time("year")
        .id("id")
        .color("{{ current_build.trade_flow }}_val")
        .coords(raw_coords)
        .height(window.innerHeight - d3.select("#ui").node().offsetHeight)
        .time({"solo": ["2010"]})
        .width(viz_width)
      
      finish(raw_data.data, attrs)
    }
    break;
}

function update_text_table(data, attrs){
  // d3.selectAll("#view_as_text a").on("click")()
  
  var format_currency = d3.format("$,.2f"),
      format_percent = d3.format(",.2%"),
      val = "{{ current_build.trade_flow }}_val",
      attr_id = "{{ current_build.attr_type() }}_id",
      total = d3.sum(data, function(d){ return d[val] });
  
  d3.selectAll("h2#total").text("Total: " + format_currency(total))
  
  var columns = ["#", "id", "name", "val", "percent"];
  table_data = []
  data = data.filter(function(d){ return d[val] > 0 })
  data.sort(function(a,b){return d3.descending(a[val], b[val]) })
  data.forEach(function(d, i){
    table_data.push({
      "#": i+1,
      "id": d[attr_id],
      "name": attrs[d[attr_id]].name,
      "val": format_currency(d[val]),
      "percent": format_percent(d[val]/total)
    })
  })
  
  var tbl = tabulate("#app #text", table_data, columns)
  // uppercase the column headers
  tbl.selectAll("thead th")
    .text(function(column) {
      return column.charAt(0).toUpperCase() + column.substr(1);
    });
  
}

/* if user requests more years, fetch raw data call for all years */
d3.select("#more_years button").on("click", function(){
  
  d3.select(this)
    .on("click",null)
    .text("Loading...")
    
  d3.json("{{ current_build.data_url('all') }}", function(raw_data){
    
    // go through raw data and set each items nest and id vars properly
    raw_data.data.forEach(function(d){
      d.nest = d[attr_id].substr(0, 2)
      d.id = d[attr_id]
    })
    
    var years = "{{ current_build.year }}"
    var year_interval = 1
    if(years.indexOf(".") > 0){
      years = years.split(".")
      year_interval = parseInt(years[2])
      years = d3.range(parseInt(years[0]), parseInt(years[1])+1, year_interval)
    }
    else {
      years = [parseInt(years)]
    }
    
    viz.data(raw_data.data).time({"solo": years}).draw()
    d3.select("#more_years").remove()
    
    // make_more_years(d3.select("#more_years"), 1995, 2011, years, 1, function(start, end){
    // var years = d3.range(start, end, year_interval)
    viz.time({"solo": years}).draw()
    
    if(parent.update_text_table){
      var data_for_table = raw_data.data.filter(function(d){ return years.indexOf(d.year) >= 0 })
      update_text_table(data_for_table, attrs)
    }
    
    resize_viz()
    // })
    
  })
  d3.event.preventDefault();
})

d3.selectAll("button#build").on("click", function(){
  
  var tf = d3.select("#trade_flow select").node().value.toLowerCase()
  
  if (d3.select("#year select").node()){
    var year = d3.select("#year select").node().value
  }
  else {
    var year = d3.select("#start_year select").node().value
    year += "."
    year += d3.select("#end_year select").node().value
    year += "."
    year += d3.select("#interval select").node().value
  }
  
  if(d3.select("#origin select").node()){
    var origin = d3.select("#origin select").node().value
  } else {
    var origin = "{{ current_build.origin.id_3char }}" || "{{ current_build.origin }}"
  }
  
  if(d3.select("#destination select").node()){
    var dest = d3.select("#destination select").node().value
  } else {
    var dest = "{{ current_build.dest.id_3char }}" || "{{ current_build.dest }}"
  }
  
  if(d3.select("#product select").node()){
    var prod = d3.select("#product select").node().value
  } else {
    var prod = "{{ current_build.product.hs }}" || "{{ current_build.product.sitc }}" || "{{ current_build.product }}"
  }
  
  if(d3.select("#classification select").node()){
    var classification = d3.select("#classification select").node().value.toLowerCase()
  } else {
    var classification = "{{ current_build.classification }}"
  }
  
  var new_url =  "/explore/{{ current_build.app.type }}/"
      new_url += classification + "/"
      new_url += tf + "/"
      new_url += origin + "/"
      new_url += dest + "/"
      new_url += prod + "/"
      new_url += year + "/"
  
  console.log(new_url)
  // window.location = new_url
  
  d3.event.preventDefault();
})

d3.select("#show_hide").on(d3plus.evt.click, function(){
  var controls = d3.select("#controls")
  if (controls.style("right") == "0px"){
    // controls.style("left", "200px")
    // resize_viz({"width": window.innerWidth})
    controls.select("i")
      .style("-webkit-transform", "rotate(180deg)")
    controls.transition().duration(600)
      .style("right", "-200px")
      .each("end", function(){
        resize_viz({"width": window.innerWidth})
      })
  }
  else {
    resize_viz()
    controls.select("i")
      .style("-webkit-transform", "rotate(0deg)")
    controls.transition().duration(600)
      .style("right", "0px")
  }
})

d3.select("#share #shorten").on("click", function(){
  
  var url = encodeURIComponent(window.location.pathname + "?lang={{ g.locale }}")
  if(window.location != window.parent.location){
    var url = encodeURIComponent(window.parent.location.pathname + "?lang={{ g.locale }}")
  }
  console.log(url)
  
  d3.json("/explore/shorten/")
    .header("Content-type","application/x-www-form-urlencoded")
    .post("url="+url, function(error,data) {
      if (data.error) {
        alert(data.error)
      }
      else{
        d3.select("#short").style("display", "block")
        d3.select("#short input").attr("value", "http://"+location.host+"/"+data.slug)
      }
    })
  
  d3.event.preventDefault();
})

// View as text
d3.selectAll("#view_as_text a").on("click", function(){
  d3.select("#app #viz").style("display", function(){
    return d3.select(this).style("display") == "none" ? "block" : "none";
  })
  d3.select("#app #text").style("display", function(){
    return d3.select(this).style("display") == "none" ? "block" : "none";
  })
  resize_viz();
  d3.event.preventDefault();
})

// Download button logic
d3.selectAll("#download a").on("click", function(){
  // Figure out the title for using as the filename
  var title = window.location.pathname.split("/")
  title.splice(0, 1)
  title.splice(0, 1)
  title.splice(title.length-1, 1)
  d3.select("input[name='title']").attr("value", title.join("_"));
  
  // Determine which link the user requested (svg, csv etc.)
  var format = d3.select(this).attr("class");
  d3.select("input[name='format']").attr("value", format);
  
  // If the user wants text, we need to put the table into an array
  // to send to the server
  if(format == "csv"){
    var data_rows = [];
    header = d3.select("#app #text table thead tr").node().innerHTML
    header = header.substr(4, header.length-4-5)
    data_rows.push(header.split("</th><th>"))
    d3.selectAll("#app #text table tbody tr").each(function(d){
      row = d3.select(this).node().innerHTML
      row = row.substr(4, row.length-4-5)
      data_rows.push(row.split("</td><td>"))
    })
    // serialize to send to server
    d3.select("input[name='content']").attr("value", d3.csv.formatRows(data_rows))
  }
  // Otherwise the user wants an image so get the SVG XML
  else {
    
    var svg = d3.select("#viz").select("svg")
      .attr("title", title.join("_"))
      .attr("version", 1.1)
      .attr("xmlns", "http://www.w3.org/2000/svg")

    // Add this content as the value of input
    var svg_xml = (new XMLSerializer).serializeToString(svg.node());
    d3.select("input[name='content']").attr("value", svg_xml)
  }
  
  // Submitting the form will trigger the action with will bring up
  // the /export page. The view for this page takes the values from
  // POST request and prompts the user to download the file
  d3.select('form#download').node().submit();
  d3.event.preventDefault();
})

d3.selectAll("#depth input").on("change", function(d){
  var new_depth = d3.select(this).property("value");
  viz.depth(new_depth).draw();
})

d3.selectAll("#color select").on("change", function(d){
  var new_color = d3.select(this[this.selectedIndex]).property("value");
  if(new_color != "color"){
    new_color = "{{ current_build.trade_flow }}_"+new_color;
  }
  viz.color(new_color).draw()
})

/////////////////////////////
// Initialize page --
////////////////////////////

/* set window resize func */
window.onresize = resize_viz

/* unleash the dogs... make the AJAX requests in order to the server and when
   they return execute the go() func */
q.await(go);
</script>

{% endblock %}