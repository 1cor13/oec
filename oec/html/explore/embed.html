{% extends "templates/base.html" %}

{% block head %}
<link type="text/css" rel="stylesheet" media="all" href="/static/css/libs/d3plus.css" />
<link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.embed.css" />
{% endblock %}

{% block content %}

<div id="loading"><h1>Loading...</h1></div>
<div id="app">
  <div id="viz"></div>
  <div id="timeline"><button>Click to view more years &raquo;</button></div>
</div>
<div id="controls">
  
  <div id="show_hide"><i class="fa fa-chevron-right"></i></div>
  
  {% for ui in current_build.get_ui() %}
  <div class="dropdown_container" id="{{ ui.name|lower|replace(" ", "_") }}">
    <h3>{{ ui.name }}</h3>
    <select>
      {% for option in ui.data %}
      <option value="{% if option is string or option is number %}{{option|replace(" ", "_")}}{% else %}{{option.display_id}}{% endif %}"
      {% if ui.current|lower|replace(" ", "_") == option|lower|replace(" ", "_") %}selected="selected"{% endif %}>
        {% if option is string or option is number %}{{ option }}
        {% else %}{{ option.name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
  </div>
  {% endfor %}
  
  <button id="build">Build Visualization</button>
  
  <div class="control_container" id="download">
    <h3>Download</h3>
    <a class="pdf" href="#"><img src="/static/img/icons/download.png"> PDF</a>
    <a class="svg" href="#"><img src="/static/img/icons/download.png"> SVG</a>
    <a class="png" href="#"><img src="/static/img/icons/download.png"> PNG</a>
    <a class="csv" href="#"><img src="/static/img/icons/download.png"> CSV</a>
  </div>
  
  <div class="control_container" id="view_as_text">
    <a class="text" href="#"><img src="/static/img/icons/text.png"> <span>View as text</span></a>
  </div>
  
  <div class="control_container">
    <h3>Embed</h3>
    <input type="text" class="embed_code" onfocus="this.select()" onMouseUp="return false" value="&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;http://atlas.media.mit.edu/explore/embed/{{ current_build.url() }}&quot; frameborder=&quot;0&quot; &gt;&lt;/iframe&gt;">
  </div>
  
  <div class="control_container" id="share">
    <h3>Share</h3>
    <a href="http://www.facebook.com/sharer.php?s=100&p[title]=Observatory of Economic Complexity&p[summary]={{ current_build.get_name() }}({{ current_build.get_year() }})&p[url]=http://atlas.media.mit.edu/explore/{{ current_build.url() }}&p[images][0]=http://atlas.media.mit.edu/static/img/icons/nav/logo_large.png" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" id="Facebook" title="Facebook">
      <i class="fa fa-facebook"></i>
    </a>
    <a href="https://twitter.com/share?url=http://atlas.media.mit.edu/explore/{{ current_build.url() }}&text={{ current_build.get_name() }}({{ current_build.get_year() }})&hashtags=oec" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')" id="Twitter" title="Tweet">
      <i class="fa fa-twitter"></i>
    </a>
    <a href="https://plus.google.com/share?url=http://atlas.media.mit.edu/explore/{{ current_build.url() }}" class="share_button" target="_blank" onclick="return !window.open(this.href, 'Google+', 'width=640,height=300')" id="Google" title="Google+">
      <i class="fa fa-google-plus"></i>
    </a>
    <a href="#" id="shorten">
      <i class="fa fa-link"></i>
    </a>
  </div>

  <div class="control_container" id="short">
    <h3>Short URL</h3>
    <input type="text" class="short_url" onfocus="this.select()" onMouseUp="return false" value="http://atlas.media.mit.edu/asdlkj43">
  </div>
  
  <!-- Hidden <FORM> to submit the SVG data to the server, which will convert it 
         to SVG/PDF/PNG downloadable file. -->
  <form id="svgform" action="/explore/download/" method="post">
    <input type="hidden" name="url" value="" />
    <input type="hidden" name="title" value="" />
    <input type="hidden" name="format" value="svg" />
    <input type="hidden" name="content" value="" />
  </form>
  
</div>

{% endblock %}

{% block js %}

<script src="/static/js/libs/modernizr.custom.js"></script>
<script src="/static/js/libs/d3plus.js"></script>
<script src="/static/js/libs/queue.js"></script>
<script src="/static/js/libs/topojson.js"></script>
<script src="/static/js/d3.brushtimeline.js"></script>

<script>

/* init vars */
var viz = d3plus.viz().container("#viz"),
    attr_id = "{{ current_build.attr_type() }}_id",
    app_type = "{{ current_build.app.type }}",
    attrs = {},
    viz_height = window.innerHeight - d3.select("#timeline").node().offsetHeight,
    viz_width = window.innerWidth - parseInt(d3.select("#controls").style("width")),
    q = queue()
          .defer(d3.json, "{{ current_build.data_url() }}")
          .defer(d3.json, "{{ current_build.attr_url() }}");

function resize_viz(obj){
  console.log("resize!")
  if(viz.data().default.length){
    var new_width = window.innerWidth - parseInt(d3.select("#controls").style("width"));
    var new_height = window.innerHeight - d3.select("#timeline").node().offsetHeight;
    if (obj){
      new_width = obj.width || new_width;
      new_height = obj.height || new_height;
    }
    viz.width(new_width).height(new_height).draw()
  }
}
/* general function needed by all apps for making proper nesting and updating
    raw data with changes */
function format_data(error, raw_data, raw_attrs, raw_other){
  
  // set key 'nest' to their id
  raw_attrs.data.forEach(function(d){
    attrs[d.id] = d
  })

  // go through raw data and set each items nest and id vars properly
  raw_data.data.forEach(function(d){
    d.nest = d[attr_id].substr(0, 2)
    d.id = d[attr_id]
  })
  
}

/* to be executed after app has been drawn for first time */
function finish(data, attrs){
  d3.select("#controls")
    .style("display", "inline-block")
    
  d3.select("#loading")
    .style("display", "none")
    
  d3.select("#viz")
    .style("display", "block")
    .call(viz)
  
  d3.select("#timeline button").style("display", "block")
  
  if(parent.update_text_table){
    parent.update_text_table(data, attrs)
  }
}

/* the ~~BIG KAHUNA~~ 
    for each different type of app we need to initialize our viz slightly
    different so instead of a bunch of if/elses we just have one large switch
    statment. Any gerealized code is put in either the format_data() func or
    the finish() func. */
switch (app_type){
  
  case "tree_map":
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1]
      
      viz
        .data(raw_data.data)
        .type("tree_map")
        .attrs(attrs)
        .size("{{ current_build.trade_flow }}_val")
        .id(["nest", "id"])
        .time({"key": "year", "solo": "{{ current_build.year }}" })
        // .time({"key": "year"})
        .depth(1)
        .shape("square")
        .style({"labels": {"align": "start"}})
        .color("color")
        .text({"nest":"name","id":"name"})
        // .title("Tree Map...")
        .title({"total": {"prefix":"Total: "}})
        .height(viz_height)
        .width(viz_width)
      
      finish(raw_data.data, attrs)
    }
    break;
  
  case "stacked":
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1]
      
      viz
        .data(raw_data.data)
        .type("stacked")
        .attrs(attrs)
        .id(["nest", "id"])
        .time({"key": "year"})
        .depth(1)
        .shape("area")
        .color("color")
        .x("year")
        .y("{{ current_build.trade_flow }}_val")
        .order("nest")
        .axes({"static":false})
        .text({"nest":"name","id":"name"})
        .height(window.innerHeight - d3.select("#timeline").node().offsetHeight)
        
      finish(raw_data.data, attrs)
    }
    break;
  
  case "network":
    q = q.defer(d3.json, "/static/json/network_{{ current_build.classification }}.json")
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1];
      raw_network = arguments[3];
            
      viz
        .data(raw_data.data)
        .attrs(attrs)
        .type("network")
        .id("id")
        .color("color")
        .time("year")
        .nodes(raw_network.nodes)
        .links(raw_network.edges)
        .active({
          "key": function(d){
            return d.export_rca >= 1;
          },
          "spotlight":true
        })
        .height(window.innerHeight - d3.select("#timeline").node().offsetHeight)
      
      finish(raw_data.data, attrs)
    }
    break;
    
  case "geo_map":
    q = q.defer(d3.json, "/static/json/country_coords.json")
    var format_data_orig = format_data
    var go = function(){
      
      format_data_orig.apply(this, arguments);
      raw_data = arguments[1];
      raw_attrs = arguments[2];
      raw_coords = arguments[3];
            
      raw_coords["objects"]["TM_WORLD_BORDERS-0.3"]["geometries"].forEach(function(d){
        country = raw_attrs.data.filter(function(dd){
          return dd.id.substr(2) == d.id.toLowerCase()
        })
        if (country.length) {
          d.id = country[0].id
        }
      })
      
      viz
        .data(raw_data.data)
        .attrs(attrs)
        .type("geo_map")
        .time("year")
        .id("id")
        .color("{{ current_build.trade_flow }}_val")
        .coords(raw_coords)
        .height(window.innerHeight - d3.select("#timeline").node().offsetHeight)
        .time({"solo": ["2010"]})
      
      finish(raw_data.data, attrs)
    }
    break;
}

/* unleash the dogs... make the AJAX requests in order to the server and when
   they return execute the go() func */
q.await(go);

/* if user requests more years, fetch raw data call for all years and create
   a timeline */
d3.select("#timeline button").on("click", function(){
  d3.json("{{ current_build.data_url('all') }}", function(raw_data){
    
    // go through raw data and set each items nest and id vars properly
    raw_data.data.forEach(function(d){
      d.nest = d[attr_id].substr(0, 2)
      d.id = d[attr_id]
    })
    
    var years = "{{ current_build.year }}"
    var year_interval = 1
    if(years.indexOf(".") > 0){
      years = years.split(".")
      year_interval = parseInt(years[2])
      years = d3.range(parseInt(years[0]), parseInt(years[1])+1, year_interval)
    }
    else {
      years = [parseInt(years)]
    }
    
    viz.data(raw_data.data).time({"solo": years}).draw()
    d3.select("#timeline button").remove()
    
    make_timeline(d3.select("#timeline"), 1995, 2011, years, 1, function(start, end){
      var years = d3.range(start, end, year_interval)
      viz.time({"solo": years}).draw()
      
      if(parent.update_text_table){
        var data_for_table = raw_data.data.filter(function(d){ return years.indexOf(d.year) >= 0 })
        parent.update_text_table(data_for_table, attrs)
      }
    })
    
  })
  d3.event.preventDefault();
})

d3.select("#show_hide").on("click", function(){
  var controls = d3.select("#controls")
  if (controls.style("right") == "0px"){
    // controls.style("left", "200px")
    // resize_viz({"width": window.innerWidth})
    controls.select("i").style("-webkit-transform", "rotate(180deg)")
    controls.transition().duration(500)
      .style("right", "-200px")
      .each("end", function(){
        resize_viz({"width": window.innerWidth})
      })
  }
  else {
    resize_viz()
    controls.select("i").style("-webkit-transform", "rotate(0deg)")
    controls.transition().delay(500).duration(500)
      .style("right", "0px")
  }
})

d3.select("#share #shorten").on("click", function(){
  
  var url = encodeURIComponent(window.location.pathname + window.location.search)
  if(window.location != window.parent.location){
    var url = encodeURIComponent(window.parent.location.pathname + window.parent.location.search)
  }
  console.log(url)
  
  d3.json("/explore/shorten/")
    .header("Content-type","application/x-www-form-urlencoded")
    .post("url="+url, function(error,data) {
      if (data.error) {
        alert(data.error)
      }
      else{
        d3.select("#short").style("display", "block")
        d3.select("#short input").attr("value", "http://"+location.host+"/"+data.slug)
      }
    })
  
  d3.event.preventDefault();
})

window.onresize = resize_viz
</script>

{% endblock %}