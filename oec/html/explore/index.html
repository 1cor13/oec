{% extends "templates/nav.html" %}

{% block head %}
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.explore.css" />
    {% if current_build.year_str|int > g.available_years[current_build.classification][0]  %}
    <link rel="prev" href="/{{ g.locale }}/explore/{{ current_build.url(year=current_build.year_str|int-1) }}" />
    {% endif %}
    {% if current_build.year_str|int < g.available_years[current_build.classification][-1]  %}
    <link rel="next" href="/{{ g.locale }}/explore/{{ current_build.url(year=current_build.year_str|int+1) }}" />
    {% endif %}

    <!-- Twitter "photo card" -->
    <meta name="twitter:card" content="photo">
    <meta name="twitter:title" content="{{ current_build.title()|striptags|safe }}">
    <meta name="twitter:image:src" content="http://atlas.media.mit.edu/static/generated/{{ g.locale }}_{{ request.path.split('/')[1:-1]|join('_') }}.png">
    <meta name="twitter:domain" content="atlas.media.mit.edu">
    <meta name="twitter:url" content="http://atlas.media.mit.edu{{ request.path }}{% if g.locale != 'en' %}?lang={{ g.locale }}{% endif %}">

    <!-- Facebook Properties -->
    <meta property="og:image" content="http://atlas.media.mit.edu/static/generated/{{ g.locale }}_{{ request.path.split('/')[1:-1]|join('_') }}.png" />
    <meta property="og:title" content="{{ current_build.title()|striptags|safe }}">
    <meta property="og:url" content="http://atlas.media.mit.edu{{ request.path }}{% if g.locale != 'en' %}?lang={{ g.locale }}{% endif %}">
    <meta property="og:site_name" content="The Observatory of Economic Complexity"/>
    <meta property="og:type" content="website" />

{% endblock %}

{% block title %}: {{ current_build.title()|striptags }} ({{ current_build.year_str }}){% endblock %}
{% block description %}{{ current_build.question() }} {{ _('Data visualization of economic trade') }}.{% endblock %}

{% block body %}

<div id="explorer">
  <a id="collapse"><i class="fa fa-cog"></i></a>
  <h1>{{ current_build.title()|safe }} ({{ current_build.year_str }})</h1>
  <div id="changers">

    {% if current_build.year_str|int > g.available_years[current_build.classification][0] and current_build.viz.slug != "stacked"  %}
    <a class="prev" href="/{{ g.locale }}/explore/{{ current_build.url(year=current_build.year_str|int-1) }}">
      <i class="fa fa-arrow-left"></i>
      {{ _('Previous Year') }}
    </a>
    {% endif %}

    {% for ui in build_ui %}
    <div class="dropdown_container" id="{{ ui.id }}"{% if ui.url %} data-url="{{ui.url}}"{% endif %}>
      <h3>{{ ui.name }}</h3>
      <select id="{{ ui.id }}_selector">
        {% if ui.data %}
          {% for option in ui.data %}
          <option{% if option.conversion %} data-conversion="{{ option.conversion }}"{% endif %}
          {% if option.icon %} data-image="{{ option.icon }}"{% endif %}
          {% if option.color %} data-color="{{ option.color }}"{% endif %}
          {% if ui.id == "product" %} data-style="knockout"{% endif %}
          {% if option.keywords %} data-keywords="{{ option.keywords }}"{% endif %}
          {% if option.display_id %} data-display_id="{{ option.display_id }}"{% endif %}
          value="{% if option is string or option is number %}{{option|replace(" ", "_")}}{% else %}{{option.display_id}}{% endif %}"
          {% if not ui.current or (ui.current|lower|replace(" ", "_") == option|lower|replace(" ", "_") or ui.current|lower|replace(" ", "_") == option.display_id) %}selected="selected"{% endif %}>
            {% if option.name %}{{ option.name }}{% else %}{{ option }}{% endif %}
          </option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
    {% endfor %}

    {% if current_build.year_str|int < g.available_years[current_build.classification][-1] and current_build.viz.slug != "stacked"  %}
    <a class="next" href="/{{ g.locale }}/explore/{{ current_build.url(year=current_build.year_str|int+1) }}">
      {{ _('Next Year') }}
      <i class="fa fa-arrow-right"></i>
    </a>
    {% endif %}

  </div>
</div>

<!-- Container for the visualization -->
<iframe class="viz" scrolling="no" frameborder="0"></iframe>

{% endblock %}

{% block js %}
<script>

  var url = "{{ current_build.url() }}",
      explorer = d3.select("#explorer"),
      iframe = d3.select("iframe.viz"),
      navWidth = d3.select("nav").node().offsetWidth;

  function resizeIframe() {
    var n = window.innerWidth <= 1024 ? 0 : navWidth,
        p = parseFloat(iframe.style("margin-left"), 10),
        w = window.innerWidth - n - p * 2,
        h = window.innerHeight - explorer.node().offsetHeight - p,
        viz = iframe.node().contentWindow.viz;

    if (viz) {
      iframe.transition().duration(500).attr("height", h + "px").attr("width", w + "px");
      viz.height(h).width(w).draw();
    }
    else {
      iframe.attr("height", h + "px").attr("width", w + "px");
    }

  }
  resizeIframe();

  d3.select("iframe.viz")
    // .style("background-color", "red")
    .attr("src", "/"+oec.locale+"/explore/embed/"+url)

  d3.select("#collapse").on("click", function(){
    explorer.classed("small", explorer.node().className !== "small");
    setTimeout(resizeIframe, 500);
  })

  resizeFunctions.push(resizeIframe);

</script>
{% endblock %}
