{% extends "templates/site.html" %}

{% block head %}
<link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.explore.css" />

<link rel="stylesheet" href="/static/js/libs/jquery-ui/jquery-ui.css" type="text/css" media="all" />
{% endblock %}

{% block title %}{{ current_build.get_name() }}{% endblock %}

{% block body %}
<div class="app_title" id="icons">
  
  {% if current_build.origin != "show" %}
  <img src="{{ current_build.origin.get_icon() }}">
  {% elif current_build.origin == "show" and current_build.product %}
  <img style="background-color: {{ current_build.product.color }};" src="{{ current_build.product.get_icon() }}">
  {% endif %}
  
  <h2 class="{{ current_build.app.type }}">{{ current_build.get_year() }}</h2>
  
  {% if current_build.dest != "show" and current_build.dest != "all" %}
  <img src="{{ current_build.dest.get_icon() }}">
  {% elif current_build.origin != "show" and current_build.product != "show" and current_build.product != "all" %}
  <img style="background-color: {{ current_build.product.color }};" src="{{ current_build.product.get_icon() }}">
  {% endif %}
</div>

<div class="app_title" id="title"><h2>{{ current_build.get_name() }}</h2></div>

<!-- the left pane -->
<div class="content">
  
  <div class="col1" id="app_pane">
  
    <h3 class="pane_title">App Selection</h3>
  
    {% set pre_app = None %}
    {% set pre_cat = None %}
    {% for build in all_builds %}

    {% if pre_app != build.app.type and pre_app != None %}
      </ul>
    </div>
    {% endif %}

    {% if pre_app != build.app.type %}
    {% set pre_app = build.app.type %}
    <div class="builds" id="{{ build.app.type }}">
      <a class="app_name" href="#{{ build.app.get_name()|lower }}" title="{{ build.app.get_name()|lower }}">
        <img style="background-color:#ccc;" src="/static/img/icons/app/app_{{build.app.type}}.png" alt="{{ build.app.get_name() }}" />
        {{ build.app.get_name() }}
      </a>
      <ul>
      {% endif %}
    
        {% if pre_cat != build.get_category() and build.get_category() != None %}
        <h4>{{ build.get_category() }}</h4>
        {% endif %}
        {% set pre_cat = build.get_category() %}
    
        <li>
        
          <a {% if build == current_build %}class="active"{% endif %} href="/explore/{{ build.url() }}">
          {{ build.get_short_name() }}
          </a>
        
        </li>
      {% endfor %}
      </ul>
    </div>
    
  </div>
  <div class="col4">

    <!-- ajax loading gif -->
    <div id="loader">
      Loading...
    </div>
  
    <!-- table of data from visualization -->
    <div id="text_data">
      {% set stats = current_build.top_stats(20) %}
      {% if stats.entries %}
      <h2 id="total">Total: {{ stats.total|format_currency }}</h2>
      <table>
        <thead><tr></tr></thead>
        <tbody>
        {% for entry in stats.entries %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ entry.attr.get_abbrv()|upper }}</td>
            <td>{{ entry.attr.get_name() }}</td>
            <td>{{ entry.value|format_currency }}</td>
            <td>{{ entry.share|format_percent }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
  
    <!-- Container for the visualization -->
    <div id="zviz">
      <iframe id="iframe_viz" src="/explore/embed/{{ current_build.url() }}" width="770" height="545" frameborder="0"></iframe>
    </div>
  
    <!-- Container for the key/legend -->
    <div class="key {{prod_class}}"  ></div>
  
  </div>

</div> <!-- END #main -->
{% endblock %}

{% block js %}
<!-- The JavaScript -->
<!-- Libraries -->
<script src="/static/js/libs/jquery/jquery-1.7.1.min.js"></script>
<script src="/static/js/libs/jquery-ui/jquery-ui.min.js"></script>
<script src="/static/js/d3.tabulate.js"></script>
<script>

d3.selectAll(".builds a.app_name").on("click", function(){
  var div_to_show_id = this.title.replace(" ", "_"),
      ul = d3.select("#"+div_to_show_id+ " ul"),
      prev_display = ul.style("height")
  
  // reset all
  // d3.selectAll(".builds ul").style("display", "none")
  d3.selectAll(".builds ul").transition().duration(500).style("height", "0px")
  
  if(prev_display == "0px"){
    var x = ul.style("height", "auto").style("height")
    ul.style("height", "0px")
    ul.transition().duration(500).style("height", x)
  }
  
  d3.event.preventDefault();
})

d3.selectAll("button#build").on("click", function(){
  
  var tf = d3.select("#trade_flow select").node().value.toLowerCase()
  
  if (d3.select("#year select").node()){
    var year = d3.select("#year select").node().value
  }
  else {
    var year = d3.select("#start_year select").node().value
    year += "."
    year += d3.select("#end_year select").node().value
    year += "."
    year += d3.select("#interval select").node().value
  }
  
  if(d3.select("#origin select").node()){
    var origin = d3.select("#origin select").node().value
  } else {
    var origin = "{{ current_build.origin.id_3char }}" || "{{ current_build.origin }}"
  }
  
  if(d3.select("#destination select").node()){
    var dest = d3.select("#destination select").node().value
  } else {
    var dest = "{{ current_build.dest.id_3char }}" || "{{ current_build.dest }}"
  }
  
  if(d3.select("#product select").node()){
    var prod = d3.select("#product select").node().value
  } else {
    var prod = "{{ current_build.product.hs }}" || "{{ current_build.product.sitc }}" || "{{ current_build.product }}"
  }
  
  if(d3.select("#classification select").node()){
    var classification = d3.select("#classification select").node().value.toLowerCase()
  } else {
    var classification = "{{ current_build.classification }}"
  }
  
  var new_url =  "/explore/{{ current_build.app.type }}/"
      new_url += classification + "/"
      new_url += tf + "/"
      new_url += origin + "/"
      new_url += dest + "/"
      new_url += prod + "/"
      new_url += year + "/"
  
  // console.log(new_url)
  window.location = new_url
  
  d3.event.preventDefault();
})

// View as text
d3.selectAll("#view_as_text a").on("click", function(){
  d3.select("#zviz").style("display", function(){
    if(d3.select(this).style("display") != "none"){
      return "none"
    }
    return "block"
  })
  d3.select("#text_data").style("position", function(){
    if(d3.select(this).style("position") != "absolute"){
      return "absolute"
    }
    return "static"
  })
  if(d3.event){
    d3.event.preventDefault();
  }
})

// Download button logic
d3.selectAll("#download a").on("click", function(){
  // Figure out the title for using as the filename
  var title = window.location.pathname.split("/")
  title.splice(0, 1)
  title.splice(0, 1)
  title.splice(title.length-1, 1)
  d3.select("input[name='title']").attr("value", title.join("_"));
  
  // Determine which link the user requested (svg, csv etc.)
  var format = $(this).attr("class");
  $("input[name='format']").attr("value", format);
  
  // If the user wants text, we need to put the table into an array
  // to send to the server
  if(format == "csv"){
    var data_rows = [];
    $("#text_data table tr").each(function(d){ 
      var this_row = [];
      var td = $(this).find('td');
      if (td.length > 0) {
        td.each(function(i) {
          var d = i == 5 ? $(this).text().replace(/,/g, "") : $(this).text();
          this_row.push(d);
        });
        data_rows.push(this_row);
      }
    })
    // serialize to send to server
    $("input[name='content']").val(JSON.stringify(data_rows))
  }
  // Otherwise the user wants an image so get the SVG XML
  else {
    var iframe = document.getElementById('iframe_viz');
    iframe = iframe.contentDocument || iframe.contentWindow.document;
    
    var svg = d3.select(iframe).select("svg")
      .attr("title", title.join("_"))
      .attr("version", 1.1)
      .attr("xmlns", "http://www.w3.org/2000/svg")

    // Add this content as the value of input
    var svg_xml = (new XMLSerializer).serializeToString(svg.node());
    d3.select("input[name='content']").attr("value", svg_xml)
  }
  
  // Submitting the form will trigger the action with will bring up
  // the /export page. The view for this page takes the values from
  // POST request and prompts the user to download the file
  // $('form.download').submit();
  d3.event.preventDefault();
})

function update_text_table(data, attrs){
  // d3.selectAll("#view_as_text a").on("click")()
  
  var format_currency = d3.format("$,.2f"),
      format_percent = d3.format(",.2%"),
      val = "{{ current_build.trade_flow }}_val",
      attr_id = "{{ current_build.attr_type() }}_id",
      total = d3.sum(data, function(d){ return d[val] });
  
  d3.selectAll("h2#total").text("Total: " + format_currency(total))
  
  var columns = ["#", "id", "name", "val", "percent"];
  table_data = []
  data = data.filter(function(d){ return d[val] > 0 })
  data.sort(function(a,b){return d3.descending(a[val], b[val]) })
  data.forEach(function(d, i){
    table_data.push({
      "#": i+1,
      "id": d[attr_id],
      "name": attrs[d[attr_id]].name,
      "val": format_currency(d[val]),
      "percent": format_percent(d[val]/total)
    })
  })
  
  var tbl = tabulate("#text_data", table_data, columns)
  // uppercase the column headers
  tbl.selectAll("thead th")
    .text(function(column) {
      return column.charAt(0).toUpperCase() + column.substr(1);
    });
  
}


/////////////////////////////
// Initialize page --
////////////////////////////

// Open default app selection accordion
var div_to_show_id = "{{ current_build.app.type }}",
    ul = d3.select("#"+div_to_show_id+ " ul");
ul.style("height", "auto")
var x = ul.style("height")
ul.transition().duration(500).style("height", x)

</script>
{% endblock %}