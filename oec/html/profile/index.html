{% extends "templates/nav.html" %}

{% set title = profile.title() %}
{% block title %} - {{ title }}{% endblock %}

{% block body %}

<article class="{{ g.page_sub_type }}">
<header class="profile_header {{ g.page_sub_type }}">
  {% set image = profile.attr.get_image() %}
  {% if image %}
  <div class="header_image">
    <img src="{{ image }}">
  </div>
  {% endif %}
  <div id="title">
    <img class="icon" src="{{ profile.attr.get_icon() }}">
    <h1>
      {{ title }}
    </h1>
  </div>

  {% set stats = profile.stats() %}
  <div id="stats">
    {% for stat in stats %}
    {% if stat.key != "eci" %}
    <div class="stat">
      <div class="stat_text">
        <h3>
          {% if "top" in stat.key %}
            {{ stat.val[2:]|upper }}
          {% elif stat.val %}
            {{ stat.val|num_format(stat.key) }}
          {% else %}
            &mdash;
          {% endif %}
        </h3>
        <sub>
          {{ stat.title }}
          {% if stat.rank %}
          <span class="rank">{{ stat.rank|num_format('ordinal') }} of {{ stat.total }}</span>
          {% endif %}
        </sub>
      </div>
      {% if stat.sparkline %}
      <div class="sparkline" data-array="{{ stat.sparkline.val }}"></div>
      <div class="years">
        <div class="year">{{ stat.sparkline.start }}</div>
        <div class="year">{{ stat.sparkline.end }}</div>
      </div>
      {% elif "top" in stat.key %}
      <a class="stat_flag" href="{{ url_for('profile.profile_country', lang=g.locale, attr_id=stat.val[2:]) }}">
        <img src="/static/img/icons/country/country_{{ stat.val }}.png">
      </a>
      {% endif %}
    </div>
    {% endif %}
    {% endfor %}
  </div>

  {% set author = profile.attr.get_author() %}
  {% if author %}
  <div class="author">
    <a href="{{ author.link }}" target="_blank">
      <i class="fa fa-camera"></i>{{ _("Photo by") }} {{ author.name }}
    </a>
  </div>
  {% endif %}

</header>
</article>

<article class="intro-article">
<section>

  <aside>
    {% if g.page_sub_type == "product" %}
    <ul class="heirarchy">
      {% for attr in profile.heirarchy() %}
      <li class="depth{{ attr.id|length }}{% if attr.id == profile.attr.id %} active{% endif %}">
        {% if attr.id|length != 2 %}
        <a href="{{ attr.get_profile_url() }}">
          <span>{{ attr.get_display_id() }}.</span> {{ attr.get_attr_name() }}
        </a>
        {% else %}
        {{ attr.get_attr_name() }}
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div id="topojson"></div>

    {% set stat = stats[0] %}
    <div class="stat" id="eci">
      <div class="stat_text">
        <h3>
          {% if stat.val %}
            {{ stat.val|num_format(stat.key) }}
          {% else %}
            &mdash;
          {% endif %}
        </h3>
        <sub>
          {{ stat.title }}
          {% if stat.rank %}
          <span class="rank">{{ stat.rank|num_format('ordinal') }} of {{ stat.total }}</span>
          {% endif %}
        </sub>
      </div>
      {% if stat.sparkline %}
      <div class="sparkline" data-array="{{ stat.sparkline.val }}"></div>
      <div class="years">
        <div class="year">{{ stat.sparkline.start }}</div>
        <div class="year">{{ stat.sparkline.end }}</div>
      </div>
      {% endif %}
    </div>
    {% endif %}

  </aside>

  <content>
    <div class="columns">
    {% for p in profile.intro() %}
      <p>{{ p|safe }}</p>
    {% endfor %}
    </div>
  </content>
</section>
</article>

<article class="viz-article">
  <script>var build_data = [];</script>
  {% set title = None %}
  {% for section in profile.sections() %}
  {% if section.title %}
  {% if title != section.title %}
  {% if title != None %}

  {% endif %}
</article>

<!-- <article{% if section.source %} class="{{ section.source }}"{% endif %}> -->

<article class="titled-section{% if section.source %} {{ section.source }}{% endif %}">
  {% set title = section.title %}
  {% endif %}
  <h1>{{ section.title }}</h1>
  {% if section.subtitle %}
  <section class="subtitle-section">
    <aside></aside>
    <content>
      <p>{{ section.subtitle|safe }}</p>
    </content>
  </section>
  {% endif %}
  {% endif %}
  {% for build in section.builds %}
  <section>
    <aside>
      <h2>{{ build.title }}</h2>
      {% if build.subtitle %}
      <p>{{ build.subtitle|safe }}</p>
      {% endif %}
      {% if not build.iframe %}
      <p><a href="/{{ g.locale }}/visualize/{{ build.build.url() }}">View Full Visualization &raquo;</a>
      {% endif %}
    </aside>
    <content>
      {% if build.iframe %}
      <iframe class="viz" data-url="{{ build.iframe }}"></iframe>
      {% else %}
      <div class="viz" data-title="{{ build.title }}"></div>
      <script>build_data.push({{ build.build.serialize()|safe }});</script>
      {% endif %}
    </content>

  </section>
  {% endfor %}
  {% endfor %}
</article>

<article>
  <section class="prof-nav">
  {% set prev = profile.attr.prev() %}
  {% if prev %}
  {% set image = prev.get_image() %}

  {% if image %}
  <div class="header prev" style="background-image: url('{{ image }}');"></div>
  {% endif %}
  <a href="{{ prev.get_profile_url() }}" class="profile_header profile_button prev"{% if not image %} style="background-color: {{ prev.color }};"{% endif %}>
    <i class="fa fa-angle-left"></i>
    <h1>
      {{ prev.get_name() }}
    </h1>
    {% if image %}
    <img class="icon" src="{{ prev.get_icon() }}">
    {% endif %}
  </a>
  {% endif %}

  {% set next = profile.attr.next() %}
  {% if next %}
  {% set image = next.get_image() %}

  {% if image %}
  <div class="header next" style="background-image: url('{{ image }}');"></div>
  {% endif %}
  <a href="{{ next.get_profile_url() }}" class="profile_header profile_button next"{% if not image %} style="background-color: {{ prev.color }};"{% endif %}>
    {% if image %}
    <img class="icon" src="{{ next.get_icon() }}">
    {% endif %}
    <h1>
      {{ next.get_name() }}
    </h1>
    <i class="fa fa-angle-right"></i>
  </a>
  {% endif %}
  </section>
</article>

<script>

  // var palette = "{{ profile.palette()|safe }}";
  // This is the old logic of using the image's palette to define color.
  // if (palette.length) {
  //   palette = JSON.parse(palette.replace(/'/g, '"'));
  //   color = analyze_palette(palette);
  //   if (!color) color = palette[1];
  // }
  // else {
  //   color = d3plus.color.legible("{{ profile.attr.color }}");
  // }
  // color = d3plus.color.legible("{{ profile.attr.color }}");

  d3.selectAll(".sparkline").each(function(){
    var w = d3.select(this).node().offsetWidth;
    d3.select(this).attr("data-width", w);
    var a = JSON.parse(d3.select(this).attr("data-array"));
    // var a = [1.171, 1.088, 1.275, 0.882, 1.171, 1.088, 1.275, 0.882, 1.171, 1.088, 1.275, 0.882];
    var y = d3.scale.linear()
      .domain([d3.min(a), d3.max(a)])
      .range([d3.select(this).node().offsetHeight, 0]);

    var x = d3.scale.linear()
      .domain([0, a.length - 1])
      .range([0, w]);

    var line = d3.svg.line()
      .x(function(d, i){ return x(i); })
      .y(function(d){ return y(d); });

    var svg = d3.select(this).append("svg")
      .attr("width", "100%")
      .append("g")
        .attr("class", "sparkgroup")
        .attr("transform", "scale(1,1)");

    var path = svg.append("path")
      .datum(a)
      .attr("class", "sparkpath")
      .attr("d", line);

    var length = path.node().getTotalLength();

    path
      .attr("stroke-dasharray", length + " " + length)
      .attr("stroke-dashoffset", length)
      .transition().duration(2500).delay(500)
        .attr("stroke-dashoffset", 0)

  });

  function resizeSparklines() {
    d3.selectAll(".sparkline").each(function(){
      var div = d3.select(this),
          w = parseFloat(div.attr("data-width"), 10),
          r = div.node().offsetWidth/w;
      div.select(".sparkgroup").attr("transform", "scale(" + r + ",1)");
    })
  }
  resizeFunctions.push(resizeSparklines);

  // If it's a country page, create the map!
  var map = d3.select("#topojson");
  if (!map.empty()) {

    var header_height = d3.select("header").node().offsetHeight;
    map.style("margin-top",-header_height-10 +"px");

    load("/static/json/country_coords.json", function(coords){

      var key = d3.keys(coords.objects)[0],
          id = "{{ profile.attr.id }}",
          width = 250,
          height = width;

      var svg = map.append("svg")
        .attr("width", width)
        .attr("height", height);

      if (!coords.objects[key].lookup) {
        coords.objects[key].lookup = coords.objects[key].geometries.reduce(function(obj, d){
          obj[d.id] = d;
          return obj;
        }, {});
        coords.objects[key].lookup.all = coords.objects[key].geometries;
      }

      var geo_ids = [id];
      if (id === "eublx") {
        geo_ids = ["eubel", "eulux"];
      }

      coords.objects[key].geometries = [];
      geo_ids.forEach(function(g){
        coords.objects[key].geometries.push(coords.objects[key].lookup[g]);
      })

      var projection = d3.geo.mercator().scale(1).translate([0, 0]),
          path = d3.geo.path().projection(projection),
          country = topojson.feature(coords, coords.objects[key]).features[0];

      // List of countries to only take largest land mass.
      if (["nausa", "saecu"].indexOf(id) >= 0) {

        var areas = [], test = d3plus.util.copy(country);
        country.geometry.coordinates.forEach(function(c, i){
          test.geometry.coordinates = [c];
          areas.push(path.area(test))
        })

        var maxArea = d3.max(areas);
        country.geometry.coordinates = country.geometry.coordinates.filter(function(c, i){
          return areas[i] >= maxArea;
        });

      }
      // List of countries that should take the largest two land masses.
      else if (["asmys", "eugbr"].indexOf(id) >= 0) {

        var areas = [], test = d3plus.util.copy(country);
        country.geometry.coordinates.forEach(function(c, i){
          test.geometry.coordinates = [c];
          areas.push(path.area(test))
        })

        var sorted = areas.slice().sort(function(a, b){ return b-a; });
        var maxArea = sorted[1];
        country.geometry.coordinates = country.geometry.coordinates.filter(function(c, i){
          return areas[i] >= maxArea;
        });

      }
      else {

        // Logic for removing small/far away geometries.
        var test = d3plus.util.copy(country),
            areas = [],
            areaMax = 0,
            distances = [],
            center = path.centroid(country);

        country.geometry.coordinates = country.geometry.coordinates.filter(function(c){

          test.geometry.coordinates = [c];
          var area = path.area(test);
          if (area > 0) {
            areas.push(area);
            if (area > areaMax) {
              areaMax = area;
            }
            distances.push(d3plus.network.distance(path.centroid(test), center))
            return true;
          }
          else {
            return false;
          }

        });

        var distanceCutoff = d3.quantile(distances.reduce(function(arr, dist, i) {
          if (dist) arr.push(areas[i]/dist);
          return arr;
        }, []), 0.9);

        country.geometry.coordinates = country.geometry.coordinates.filter(function(c, i){
          return distances[i] === 0 || areas[i]/distances[i] >= distanceCutoff;
        });

      }

      var b = path.bounds(country),
          zoom = 0.70,
          s = zoom / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
          t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

      coords.objects[key].geometries = coords.objects[key].lookup.all;
      var countries = topojson.feature(coords, coords.objects[key]);

      projection
        .scale(s)
        .translate(t);

      var scale = 0.5;
      var group = svg.append("g")
        // .attr("transform", "translate("+(width*(scale/2))+","+(height*(scale/2))+")scale("+scale+","+scale+")");

      group.selectAll("path").data(countries.features)
        .enter().append("path")
        .attr("d", path)
        .attr("class", "coords")
        .classed("focus", function(d){
          return geo_ids.indexOf(d.id) >= 0 ? true : false;
        });

      map.classed("loaded", true);

      // group.transition().duration(1000)
      //   .attr("transform", "translate(0,0)scale(1,1)");

    });

  }

  var heirarchy = d3.select("ul.heirarchy");
  if (!heirarchy.empty()) {
    function heirarchyHeight() {
      var ch = d3.select(".columns").node().offsetHeight;
      heirarchy.style("max-height", ch + 60 + "px");
    }
    heirarchyHeight();
    resizeFunctions.push(heirarchyHeight);
  }

  var builds = [];
  d3.selectAll(".viz").each(function(d, i){
    builds.push({
      "container": d3.select(this),
      "height": this.offsetHeight,
      "index": i,
      "loaded": false,
      "timer": false,
      "top": this.offsetTop
    })
  })

  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+100 && top+100 < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 500;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            if (buildInView(build)) {
              buildLoad(build)
            }
          }, ms, b)

        }
      }
    }
  }

  function buildLoad(build) {
    var url = build.container.attr("data-url");
    if (url) {
      build.container.attr("src", url);
    }
    else {
      visualization(build_data[build.index], build.container);
    }
    build.loaded = true;
  }

  buildScroll(0);

  scrollFunctions.push(buildScroll);

  var classification = "{{ g.page_sub_type }}";
  if (classification === "product") classification = "hs92";
  d3.select("header #title").on("click", function(){
    search(classification);
  })

  // Demo Mode
  // setTimeout(function(){
  //   var s = 0;
  //   var scroller = setInterval(function(){
  //     window.scrollTo(0, s);
  //     s++;
  //     if (s === 4000) {
  //       clearInterval(scroller);
  //       window.location = "/en/profile/country/";
  //     };
  //   }, 25);
  // }, 7000);

</script>
{% endblock %}
