{% extends "templates/nav.html" %}

{% set title = profile.title() %}
{% block title %} - {{ title }}{% endblock %}

{% block body %}

<header>
  {% set image = profile.attr.get_image() %}
  {% if image %}
  <img id="header" src="{{ image }}"></img>
  {% endif %}
  <img id="icon" src="{{ profile.attr.get_icon() }}">
  <h1>{{ title }}</h1>
</header>

<section id="stats">
  <div class="stat">
    <sub>Exports</sub>
    <h3>$4.5B</h3>
  </div>
  <div class="stat">
    <sub>Imports</sub>
    <h3>$3.7T</h3>
  </div>
  <div class="stat">
    <sub>ECI</sub>
    <h3>1.34</h3>
  </div>
  <div class="stat">
    <sub>Population</sub>
    <h3>4.3M</h3>
  </div>
  <div class="stat">
    <sub>GDP</sub>
    <h3>$25k</h3>
  </div>
</section>

<section>

  <aside>
    {% if g.page_sub_type == "product" %}
    <ul>
      {% for attr in profile.heirarchy() %}
      <li class="depth{{ attr.id|length }}{% if attr.id == profile.attr.id %} active{% endif %}"><a href="{{ attr.get_profile_url() }}">
        {{ attr.id }} - {{ attr.get_attr_name() }}
      </a></li>
      {% endfor %}
    </ul>
    {% else %}
    <div id="topojson"></div>
    {% endif %}
  </aside>

  <content>
    <h2>{% trans %}Introduction{% endtrans %}</h2>
    {% for p in profile.intro() %}
      <p>{{ p|safe }}</p>
    {% endfor %}
  </content>

</section>

{% for section in profile.sections() %}
<section>
  <aside></aside>
  <content>
    <h2>{{ section.title }}</h2>
    {% if section.subtitle %}
    <p>{{ section.subtitle }}</p>
    {% endif %}
  <content>
</section>
{% for build in section.builds %}
<section>
  <aside>
    <h2>{{ build.title }}</h2>
    {% if build.subtitle %}
    <p>{{ build.subtitle }}</>
    {% endif %}
  </aside>

  <content>
    {% if build.iframe %}
    <iframe class="viz" data-url="{{ build.iframe }}"></iframe>
    {% else %}
    <div class="viz" data-title="{{ build.title }}"></div>
    {% endif %}
  </content>

</section>
{% endfor %}
{% endfor %}

<script>

  var palette = JSON.parse("{{ profile.palette()|safe }}".replace(/'/g, '"')),
      color;

  if (palette.length) {
    for (var p = 0; p < palette.length; p++) {
      var c = d3.hsl(palette[p]);
      if (c.l > 0.5) {
        color = d3plus.color.legible(palette[p]);
        break;
      }
    }
    if (!color) color = palette[1];
  }
  else {
    color = "{{ profile.attr.color }}";
  }

  // If it's a country page, create the map!
  var map = d3.select("#topojson");
  if (!map.empty()) {

    load("/static/json/country_coords.json", function(coords){

      var key = d3.keys(coords.objects)[0],
          width = map.node().parentNode.offsetWidth,
          height = width;

      if (!coords.objects[key].lookup) {
        coords.objects[key].lookup = coords.objects[key].geometries.reduce(function(obj, d){
          obj[d.id] = d;
          return obj;
        }, {});
      }

      coords.objects[key].geometries = [coords.objects[key].lookup["{{ profile.attr.id }}"]];

      var svg = map.append("svg")
        .attr("width", width)
        .attr("height", height);

      var projection = d3.geo.mercator().scale(1).translate([0, 0]),
          path = d3.geo.path().projection(projection),
          country = topojson.feature(coords, coords.objects[key]).features[0];

      // Logic for removing small/far away geometries.
      var test = d3plus.util.copy(country),
          areas = [],
          areaMax = 0,
          distances = [],
          center = path.centroid(country);

      country.geometry.coordinates = country.geometry.coordinates.filter(function(c){

        test.geometry.coordinates = [c];
        var area = path.area(test);
        if (area > 0) {
          areas.push(area);
          if (area > areaMax) {
            areaMax = area;
          }
          distances.push(d3plus.network.distance(path.centroid(test), center))
          return true;
        }
        else {
          return false;
        }

      });

      var distanceCutoff = d3.quantile(distances.reduce(function(arr, dist, i) {
        if (dist) arr.push(areas[i]/dist);
        return arr;
      }, []), 0.9);

      country.geometry.coordinates = country.geometry.coordinates.filter(function(c, i){
        return distances[i] === 0 || areas[i]/distances[i] >= distanceCutoff;
      });

      var b = path.bounds(country),
          s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
          t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

      projection
        .scale(s)
        .translate(t);

      svg.append("path")
        .datum(country)
        .attr("d", path)
        .attr("opacity", 0)
        .attr("fill", color)
        .transition().duration(1000)
          .attr("opacity", 1);


    });

  }

  var builds = [];
  d3.selectAll(".viz").each(function(d, i){
    builds.push({
      "container": d3.select(this),
      "height": this.offsetHeight,
      "index": i,
      "loaded": false,
      "timer": false,
      "top": this.offsetTop
    })
  })

  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+100 && top+100 < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 500;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            if (buildInView(build)) {
              buildLoad(build)
            }
          }, ms, b)

        }
      }
    }
  }

  function buildLoad(build) {
    var url = build.container.attr("data-url");
    if (url) {
      build.container.attr("src", url);
    }
    console.log("load:", build);
    build.loaded = true;
  }

  buildScroll(0);

  scrollFunctions.push(buildScroll);

</script>
{% endblock %}
