{% extends "templates/nav.html" %}

{% block body %}

<header>
  <img id="header" src="{{ profile.attr.get_image() }}"></img>
  <img id="icon" src="{{ profile.attr.get_icon() }}">
  <h1>{{ profile.title() }}</h1>
</header>

<section id="stats">
  <div class="stat">
    <sub>Exports</sub>
    <h3>$4.5B</h3>
  </div>
  <div class="stat">
    <sub>Imports</sub>
    <h3>$3.7T</h3>
  </div>
  <div class="stat">
    <sub>ECI</sub>
    <h3>1.34</h3>
  </div>
  <div class="stat">
    <sub>Population</sub>
    <h3>4.3M</h3>
  </div>
  <div class="stat">
    <sub>GDP</sub>
    <h3>$25k</h3>
  </div>
</section>

<section>

  <aside>
    <div class="viz"></div>
  </aside>

  <content>
    <h2>{% trans %}Introduction{% endtrans %}</h2>
    {% for p in profile.intro() %}
      <p>{{ p|safe }}</p>
    {% endfor %}
  </content>

</section>

{% for section in profile.sections() %}
<section>
  <aside></aside>
  <content>
    <h2>{{ section.title }}</h2>
    {% if section.subtitle %}
    <p>{{ section.subtitle }}</p>
    {% endif %}
  <content>
</section>
{% for build in section.builds %}
<section>
  <aside>
    <h2>{{ build.title }}</h2>
    {% if build.subtitle %}
    <p>{{ build.subtitle }}</>
    {% endif %}
  </aside>

  <content>
    {% if build.iframe %}
    <iframe class="viz" data-url="{{ build.iframe }}"></iframe>
    {% else %}
    <div class="viz" data-title="{{ build.title }}"></div>
    {% endif %}
  </content>

</section>
{% endfor %}
{% endfor %}

<script>

  var palette = JSON.parse("{{ profile.palette()|safe }}".replace(/'/g, '"')),
      color;
  for (var p = 0; p < palette.length; p++) {
    var c = d3.hsl(palette[p]);
    if (c.l > 0.5) {
      color = d3plus.color.legible(palette[p]);
      break;
    }
  }
  if (!color) color = palette[1];

  var builds = [];
  d3.selectAll(".viz").each(function(d, i){
    builds.push({
      "container": d3.select(this),
      "height": this.offsetHeight,
      "index": i,
      "loaded": false,
      "timer": false,
      "top": this.offsetTop
    })
  })

  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+100 && top+100 < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 500;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            if (buildInView(build)) {
              buildLoad(build)
            }
          }, ms, b)

        }
      }
    }
  }

  function buildLoad(build) {
    var url = build.container.attr("data-url");
    if (url) {
      build.container.attr("src", url);
    }
    console.log("load:", build);
    build.loaded = true;
  }

  buildScroll(0);

  scrollFunctions.push(buildScroll);

</script>
{% endblock %}
